---
import BaseHead from '../components/BaseHead.astro'
import SlideConfig from '../components/inference/SlideConfig.tsx'

import '@fontsource/source-sans-3'
import '@fontsource-variable/jetbrains-mono'
import '@fontsource/crimson-pro'
import '@fontsource/noto-sans-math'
import 'katex/dist/katex.min.css'

interface Props {
	title: string
	description: string
}

const { title, description } = Astro.props
---

<!doctype html>
<html lang="en">
	<head>
		<BaseHead title={title} description={description} />
	</head>
	<body
		class="text-foreground bg-background font-light dark:text-foreground-dark dark:bg-background-dark h-screen overflow-hidden flex"
	>
		<!-- Slide area -->
		<div class="flex-1 relative overflow-hidden">
			<!-- Config popover -->
			<div class="absolute top-4 right-4 z-20">
				<SlideConfig client:load />
			</div>

			<div id="slide-container" class="w-full h-full relative">
				<slot />
			</div>

			<!-- Navigation controls -->
			<div class="absolute bottom-4 right-4 flex items-center gap-4 z-10">
				<span id="slide-counter" class="text-sm opacity-50 font-mono"></span>
				<div class="flex flex-col items-center gap-1">
					<button
						id="up-btn"
						class="px-2 py-1 text-sm border border-foreground/15 dark:border-foreground-dark/15 rounded hover:bg-foreground/5 dark:hover:bg-foreground-dark/5 transition-colors disabled:opacity-20"
						aria-label="Detail up"
					>&uarr;</button>
					<div class="flex gap-1">
						<button
							id="prev-btn"
							class="px-2 py-1 text-sm border border-foreground/15 dark:border-foreground-dark/15 rounded hover:bg-foreground/5 dark:hover:bg-foreground-dark/5 transition-colors"
							aria-label="Previous slide"
						>&larr;</button>
						<button
							id="down-btn"
							class="px-2 py-1 text-sm border border-foreground/15 dark:border-foreground-dark/15 rounded hover:bg-foreground/5 dark:hover:bg-foreground-dark/5 transition-colors disabled:opacity-20"
							aria-label="Detail down"
						>&darr;</button>
						<button
							id="next-btn"
							class="px-2 py-1 text-sm border border-foreground/15 dark:border-foreground-dark/15 rounded hover:bg-foreground/5 dark:hover:bg-foreground-dark/5 transition-colors"
							aria-label="Next slide"
						>&rarr;</button>
					</div>
				</div>
			</div>
		</div>
	</body>
</html>

<style is:global>
	.slide-stack {
		display: contents;
	}

	.slide {
		position: absolute;
		inset: 0;
		padding: 2.5rem;
		overflow-y: auto;
		visibility: hidden;
		opacity: 0;
		transition: opacity 0.15s ease;
	}

	.slide.active {
		visibility: visible;
		opacity: 1;
	}

	/* Hide blog-style sidenote controls inside slides */
	.slide .sidenote-unnumbered-wrapper {
		display: none;
	}

	/* Slide notes: hover tooltips */
	.note {
		text-decoration: underline dotted;
		text-decoration-color: var(--color-primary);
		text-underline-offset: 3px;
		cursor: help;
		position: relative;
	}

	:is(.dark) .note {
		text-decoration-color: var(--color-primary-dark);
	}

	.note:hover::after {
		content: attr(data-note);
		position: absolute;
		bottom: calc(100% + 8px);
		left: 50%;
		transform: translateX(-50%);
		padding: 0.5rem 0.75rem;
		font-size: 0.875rem;
		line-height: 1.4;
		font-family: var(--font-sans);
		font-weight: 300;
		white-space: normal;
		width: max-content;
		max-width: 20rem;
		border-radius: 0.375rem;
		background: var(--color-foreground);
		color: var(--color-background);
		z-index: 20;
		pointer-events: none;
	}

	:is(.dark) .note:hover::after {
		background: var(--color-foreground-dark);
		color: var(--color-background-dark);
	}
</style>

<script is:inline>
	// Theme detection (mirrors Navbar.astro logic)
	;(function() {
		if (
			localStorage.theme === 'dark' ||
			(!('theme' in localStorage) &&
				window.matchMedia('(prefers-color-scheme: dark)').matches)
		) {
			document.documentElement.classList.add('dark')
		} else {
			document.documentElement.classList.remove('dark')
		}
	})()
</script>

<script>
	function initSlides() {
		// Build 2D grid: array of stacks, each stack is an array of slide elements
		const stacks: HTMLElement[][] = []
		const container = document.getElementById('slide-container')!
		const children = Array.from(container.children) as HTMLElement[]

		for (const child of children) {
			if (child.classList.contains('slide-stack')) {
				// Grouped slides
				const slides = Array.from(child.querySelectorAll<HTMLElement>('.slide'))
				if (slides.length > 0) stacks.push(slides)
			} else if (child.classList.contains('slide')) {
				// Standalone slide
				stacks.push([child])
			}
		}

		const counter = document.getElementById('slide-counter')!
		const prevBtn = document.getElementById('prev-btn') as HTMLButtonElement
		const nextBtn = document.getElementById('next-btn') as HTMLButtonElement
		const upBtn = document.getElementById('up-btn') as HTMLButtonElement
		const downBtn = document.getElementById('down-btn') as HTMLButtonElement
		const totalColumns = stacks.length

		function getPositionFromHash(): [number, number] {
			const match = location.hash.match(/^#slide-(\d+)(?:-(\d+))?$/)
			if (match) {
				const col = parseInt(match[1], 10) - 1
				const row = match[2] ? parseInt(match[2], 10) - 1 : 0
				if (col >= 0 && col < totalColumns) {
					const maxRow = stacks[col].length - 1
					return [col, Math.min(row, maxRow)]
				}
			}
			return [0, 0]
		}

		let [col, row] = getPositionFromHash()

		function show(newCol: number, newRow: number) {
			// Hide all slides
			for (const stack of stacks) {
				for (const slide of stack) {
					slide.classList.remove('active')
				}
			}

			col = newCol
			row = newRow
			stacks[col][row].classList.add('active')

			// Update counter
			if (row === 0) {
				counter.textContent = `${col + 1} / ${totalColumns}`
			} else {
				counter.textContent = `${col + 1}.${row + 1} / ${totalColumns}`
			}

			// Enable/disable vertical nav buttons
			upBtn.disabled = row === 0
			downBtn.disabled = row >= stacks[col].length - 1

			// Update hash
			const hash = row === 0 ? `#slide-${col + 1}` : `#slide-${col + 1}-${row + 1}`
			history.replaceState(null, '', hash)

			// Trigger resize for Chart.js
			window.dispatchEvent(new Event('resize'))
		}

		function right() {
			if (col < totalColumns - 1) show(col + 1, 0)
		}

		function left() {
			if (col > 0) show(col - 1, 0)
		}

		function down() {
			if (row < stacks[col].length - 1) show(col, row + 1)
		}

		function up() {
			if (row > 0) show(col, row - 1)
		}

		prevBtn.addEventListener('click', left)
		nextBtn.addEventListener('click', right)
		upBtn.addEventListener('click', up)
		downBtn.addEventListener('click', down)

		container.addEventListener('click', (e) => {
			const target = e.target as HTMLElement
			// Skip if clicking on interactive elements or their children
			if (target.closest('button, a, input, select, textarea, label, .note, canvas')) return
			right()
		})

		document.addEventListener('keydown', (e) => {
			const tag = (e.target as HTMLElement).tagName
			if (tag === 'INPUT' || tag === 'SELECT' || tag === 'TEXTAREA') return

			if (e.key === 'ArrowRight' || e.key === ' ') {
				e.preventDefault()
				right()
			} else if (e.key === 'ArrowLeft') {
				e.preventDefault()
				left()
			} else if (e.key === 'ArrowDown') {
				e.preventDefault()
				down()
			} else if (e.key === 'ArrowUp') {
				e.preventDefault()
				up()
			}
		})

		window.addEventListener('hashchange', () => {
			const [newCol, newRow] = getPositionFromHash()
			show(newCol, newRow)
		})

		show(col, row)
	}

	if (document.readyState === 'loading') {
		document.addEventListener('DOMContentLoaded', initSlides)
	} else {
		initSlides()
	}
</script>
